<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns:ui="http://java.sun.com/jsf/facelets"
      template="/resources/template/template.xhtml"
      xmlns:h="http://java.sun.com/jsf/html"
      xmlns:p="http://primefaces.org/ui"
      xmlns:f="http://java.sun.com/jsf/core"
      xmlns="http://www.w3.org/1999/xhtml"
      xmlns:a="http://xmlns.jcp.org/jsf/passthrough"
      xmlns:phi="http://java.sun.com/jsf/composite/pharmacy"
      xmlns:bi="http://java.sun.com/jsf/composite/bill"
      xmlns:pa="http://java.sun.com/jsf/composite/paymentMethod"
      xmlns:pat="http://java.sun.com/jsf/composite/patient">

    <h:body>

        <ui:composition template="/resources/template/template.xhtml">

            <ui:define name="content">


                <h:panelGroup rendered="#{!(webUserController.hasPrivilege('OpdBilling') or webUserController.hasPrivilege('LabCashier'))}" >
                    You are NOT authorized
                </h:panelGroup>

                <h:panelGroup rendered="#{webUserController.hasPrivilege('OpdBilling') or webUserController.hasPrivilege('LabCashier')}" styleClass="opdPanel" >
                    <h:form id="form">
                        <p:growl autoUpdate="true" id="growl" ></p:growl>
                        <p:focus id="focusIx" for="acIx" />
                        <f:facet name="header">
                            <h:outputLabel value="OPD"/>
                        </f:facet>
                        <h:panelGroup rendered="#{!billController.printPreview}" styleClass="alignTop" >

                            <div class="card" >
                                <div class="card-header" >
                                    <h:commandButton  value="Settle" 
                                                      action="#{billController.settleBill}" 
                                                      class="btn btn-success mr-1"
                                                      >
                                    </h:commandButton>
                                    <h:commandButton value="New Bill" 
                                                     class="btn btn-danger mr-1"
                                                     action="#{billController.prepareNewBill()}" >
                                    </h:commandButton>
                                    <h:commandButton value="Print Last Bill"  
                                                     class="btn btn-primary mr-1"
                                                     action="opd_bill_print_last" >
                                    </h:commandButton>
                                </div>
                                <div class="card-body" >
                                    <div class="row" >
                                        <div class="col-md-6" >
                                            <div class="form" >
                                                <p:tabView id="tvPt" activeIndex="#{billController.patientSearchTab}" class="w-100 m-0 p-0" >
                                                    <p:tab id="tabNewPt" title="New Patient"   >
                                                        <div class="form-row">
                                                            <div class="form-group col-md-3">
                                                                <h:selectOneMenu  id="cmbTitle"  
                                                                                  class="form form-control" 
                                                                                  value="#{billController.newPatient.person.title}"  >
                                                                    <f:selectItem itemLabel="Select Title" />
                                                                    <f:selectItems value="#{billController.title}" var="i" 
                                                                                   itemLabel="#{i.label}" itemValue="#{i}"/>
                                                                </h:selectOneMenu>
                                                            </div>
                                                            <div class="form-group col-md-9">
                                                                <h:inputText autocomplete="off"  id="txtNewPtName" 
                                                                             a:placeholder="Enter the Name of the patient"
                                                                             class="form form-control" 
                                                                             value="#{billController.newPatient.person.name}" 
                                                                             >
                                                                </h:inputText>
                                                            </div>
                                                        </div>
                                                        <div class="form-row">
                                                            <div class="form-group col-md-3">
                                                                <h:selectOneMenu id="txtNewSex" 
                                                                                 class="form form-control" 
                                                                                 value="#{billController.newPatient.person.sex}" >
                                                                    <f:selectItem itemLabel="Select Gender"/>
                                                                    <f:selectItems value="#{billController.sex}"/>
                                                                </h:selectOneMenu>
                                                            </div>
                                                            <div class="form-group col-md-2">
                                                                <h:inputText autocomplete="off"  id="year"  
                                                                             value="#{billController.yearMonthDay.year}" 
                                                                             class="form form-control" >
                                                                    <f:ajax event="keyup" execute="@this month day" render="calNewPtDob" 

                                                                            listener="#{billController.dateChangeListen()}"  />
                                                                </h:inputText>
                                                            </div>
                                                            <div class="form-group col-md-2">
                                                                <h:inputText autocomplete="off" id="month"
                                                                             class="form form-control" 
                                                                             value="#{billController.yearMonthDay.month}">
                                                                    <f:ajax event="keyup" execute="@this year day" render="calNewPtDob" listener="#{billController.dateChangeListen()}"  />
                                                                </h:inputText>
                                                            </div>
                                                            <div class="form-group col-md-2">
                                                                <h:inputText autocomplete="off" id="day" 
                                                                             class="form form-control" 
                                                                             value="#{billController.yearMonthDay.day}">
                                                                    <f:ajax event="keyup" execute="@this year month" render="calNewPtDob" listener="#{billController.dateChangeListen()}" />
                                                                </h:inputText>
                                                            </div>
                                                            <div class="form-group col-md-3">
                                                                <p:calendar  value="#{billController.newPatient.person.dob}" 
                                                                             inputStyleClass="form form-control"
                                                                             id="calNewPtDob"  navigator="true" pattern="dd/MM/yyyy" 
                                                                             >
                                                                    <f:ajax event="dateSelect" />
                                                                </p:calendar>
                                                            </div>
                                                        </div>
                                                        <div class="form-row">
                                                            <div class="form-group col-md-3">
                                                                <h:inputText 
                                                                    id="txtNewPtPhone" 
                                                                    autocomplete="off" 
                                                                    a:placeholder="Phone Number"
                                                                    value="#{billController.newPatient.person.phone}"
                                                                    class="form form-control"
                                                                    >
                                                                </h:inputText>
                                                            </div>
                                                            <div class="form-group col-md-3">
                                                                <h:inputText 
                                                                    a:placeholder="National ID No." 
                                                                    value="#{billController.newPatient.person.nic}"
                                                                    class="form form-control"/>

                                                            </div>
                                                            <div class="form-group col-md-3">
                                                                <h:inputText autocomplete="off" id="txtEmail" a:placeholder="Enter Email here"
                                                                             value="#{billController.newPatient.person.email}"
                                                                             class="form form-control">
                                                                </h:inputText>
                                                            </div>
                                                            <div class="form-group col-md-3">
                                                                <h:inputText 
                                                                    a:placeholder="PHN(Leave Blank to Generate a new one)" 
                                                                    value="#{billController.newPatient.person.nic}"
                                                                    class="form form-control"/>
                                                            </div>

                                                        </div>
                                                        <div class="form-row">
                                                            <div class="form-group col-md-12">
                                                                <h:inputText  a:placeholder="Address" 
                                                                              value="#{billController.newPatient.person.address}"
                                                                              class="form form-control"/>
                                                            </div>
                                                        </div>
                                                    </p:tab>
                                                    <p:tab id="tabSearchPt" title="Search Patient">
                                                        <h:panelGrid columns="1" >
                                                            <p:selectBooleanCheckbox value="#{patientController.reportKeyWord.additionalDetails}" 
                                                                                     itemLabel="Serch Only Registed Patient" >
                                                                <f:ajax execute="@this" render="acPt" />
                                                            </p:selectBooleanCheckbox>
                                                            <p:autoComplete styleClass="mediuminput" converter="patientConverter"
                                                                            disabled="#{billController.fromOpdEncounter}"
                                                                            widgetVar="aPt" id="acPt" forceSelection="true" 
                                                                            value="#{billController.searchedPatient}" 
                                                                            completeMethod="#{patientController.completePatientByNameOrCode}" 
                                                                            var="apt" itemLabel="#{apt.person.name}" 
                                                                            itemValue="#{apt}" size="30"  style="width: 400px;"
                                                                            minQueryLength="4">
                                                                <p:column headerText="Name">
                                                                    <h:outputLabel value="#{apt.person.nameWithTitle}" />
                                                                </p:column>
                                                                <p:column headerText="Phone">
                                                                    <h:outputLabel value="#{apt.person.phone}" />
                                                                </p:column>
                                                                <p:column headerText="Age">
                                                                    <h:outputLabel value="#{apt.age}" />
                                                                </p:column>
                                                                <p:column headerText="Code">
                                                                    <h:outputLabel value="#{apt.code}" />
                                                                </p:column>
                                                                <p:column headerText="Sex">
                                                                    <h:outputLabel value="#{apt.person.sex}" />
                                                                </p:column>
                                                                <p:column headerText="Address">
                                                                    <h:outputLabel value="#{apt.person.address}" />
                                                                </p:column>
                                                                <p:column headerText="Date of Birth">
                                                                    <h:outputLabel value="#{apt.person.dob}" >
                                                                        <f:convertDateTime pattern="dd MMMM yyyy"/>
                                                                    </h:outputLabel>
                                                                </p:column>
                                                            </p:autoComplete>   
                                                            <h:panelGroup id="panSearch">
                                                                <pat:searchPatientDetail patient="#{billController.searchedPatient}"  />
                                                            </h:panelGroup>
                                                            <div style="padding: 2px; margin: 2px; border: 1px solid;">
                                                                <p:outputLabel value="#{pharmacySaleController.opdEncounterComments}" ></p:outputLabel>
                                                            </div>
                                                        </h:panelGrid>
                                                    </p:tab>
                                                </p:tabView>
                                            </div>
                                        </div>
                                        <div class="col-md-6" >
                                            <div class="form-row">
                                                <div class="form-group col-md-12">
                                                    <h:outputLabel value="Referring Institution" 
                                                                   class="form form-label"
                                                                   ></h:outputLabel>
                                                    <p:autoComplete id="refIns" 
                                                                    inputStyleClass="form form-control"
                                                                    forceSelection="true" 
                                                                    value="#{billController.referredByInstitution}"
                                                                    completeMethod="#{institutionController.completeIns}"
                                                                    var="ri" 
                                                                    itemLabel="#{ri.name}" 
                                                                    itemValue="#{ri}" 
                                                                    size="30"  
                                                                    class="form form-control" 
                                                                    >
                                                        <p:column>#{ri.institutionCode}</p:column>
                                                        <p:column>#{ri.name}</p:column>
                                                    </p:autoComplete>
                                                </div>
                                            </div>
                                            <div class="form-row">
                                                <div class="form-group col-md-12">
                                                    <h:outputLabel value="Referring Doctor" class="form form-label" ></h:outputLabel>
                                                    <p:autoComplete forceSelection="true" id="cmbDoc" value="#{billController.referredBy}" 
                                                                    completeMethod="#{doctorController.completeDoctor}" var="ix" 
                                                                    itemLabel="#{ix.person.name}" itemValue="#{ix}" 
                                                                    inputStyleClass="form form-control"
                                                                    class="form form-control" 
                                                                    >
                                                        <p:column headerText="Name" >
                                                            <h:outputLabel value="#{ix.person.nameWithTitle}" ></h:outputLabel>
                                                        </p:column>
                                                        <p:column headerText="Code" >
                                                            <h:outputLabel value="#{ix.code}" ></h:outputLabel>
                                                        </p:column>
                                                    </p:autoComplete>
                                                </div>
                                            </div>
                                            <div class="form-row">
                                                <div class="form-group col-md-12">
                                                    <h:outputLabel value="Notes" class="form form-label" ></h:outputLabel>
                                                    <h:inputTextarea value="#{billController.comment}" class="form form-control" ></h:inputTextarea>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row" >
                                        <div class="col col-md-6" >
                                            <h:panelGroup id="panelIx" >


                                                <p:panel id='pIxAdd' header="Items / Services"
                                                         style="min-height: 350px;"  >



                                                    <p:focus  context="acIx"/>

                                                    <p:autoComplete widgetVar="aIx" id="acIx" forceSelection="true"
                                                                    value="#{billController.currentBillItem.item}" 
                                                                    completeMethod="#{itemController.completeOpdItems}"
                                                                    var="ix" itemLabel="#{ix.name}" itemValue="#{ix}"
                                                                    size="10"  style="width: 400px;" maxResults="10" >
                                                        <p:column style="max-width: 200px;" headerText="Name">
                                                            <p:outputLabel value="#{ix.name}" ></p:outputLabel>
                                                            <h:panelGroup rendered="#{ix.name ne ix.fullName}" >
                                                                <p:outputLabel value=" (#{ix.fullName})" ></p:outputLabel>
                                                            </h:panelGroup>
                                                        </p:column>
                                                        <p:column style="max-width: 200px;" headerText="Dept">
                                                            <h:outputLabel value="#{ix.department.name}"></h:outputLabel>
                                                        </p:column>
                                                        <p:column style="max-width: 200px;" headerText="Code">
                                                            <h:outputLabel value="#{ix.code}"></h:outputLabel>
                                                        </p:column>
                                                        <p:column style="text-align: right; max-width: 80px;" headerText="Value">
                                                            <h:outputLabel value="#{ix.total}"></h:outputLabel>
                                                        </p:column>
                                                        <p:ajax event="itemSelect"  listener="#{billController.fillBillSessions}" process="acIx" update="tblSs" ></p:ajax>
                                                        <f:ajax event="itemSelect"  execute="@this" render="txtQty" />
                                                    </p:autoComplete>
                                                    <h:commandButton id="btnAddIx" value="Add" action="#{billController.addToBill()}"  style="width: 75px;"  >
                                                        <f:ajax execute="txtQty acIx btnAddIx panelBillItems" render="focusIx tblBillItem pIxAdd" />
                                                    </h:commandButton>

                                                    <h:panelGrid id="txtQty">
                                                        <h:inputText autocomplete="off" 
                                                                     rendered="#{billController.currentBillItem.item.requestForQuentity}"
                                                                     value="#{billController.currentBillItem.qty}" >
                                                        </h:inputText>
                                                    </h:panelGrid>
                                                    <p:selectOneMenu value="#{itemController.reportKeyWord.department}">     
                                                        <f:selectItem itemLabel="Filter by Department"/>
                                                        <f:selectItems value="#{departmentController.labs}" 
                                                                       var="paysch" itemLabel="#{paysch.name}" itemValue="#{paysch}"  />
                                                        <p:ajax process="@this" update="acIx" event="change"/>
                                                    </p:selectOneMenu><br></br>
                                                    <p:calendar value="#{billController.currentBillItem.item}" pattern="dd MMMM yyyy hh:mm a" ></p:calendar>
                                                    <!--<p:defaultCommand target="btnAddIx" />-->
                                                    <p:panel header="Session"  >
                                                        <p:calendar id="calS" mode="inline" value="#{billController.sessionDate}" pattern="dd MMMM yyyy" >
                                                            <f:ajax event="dateSelect" execute="calS" render="tblSs :#{p:component('lblTemS')}" listener="#{billController.fillBillSessionsLstner}" />
                                                        </p:calendar>
                                                        <p:selectOneMenu value="#{itemController.reportKeyWord.department}">     
                                                            <f:selectItem itemLabel="Select Department"/>
                                                            <f:selectItems value="#{departmentController.labs}" 
                                                                           var="paysch" itemLabel="#{paysch.name}" itemValue="#{paysch}"  />
                                                            <p:ajax process="@this" update="acIx" event="change"/>
                                                        </p:selectOneMenu><br></br>
                                                        <p:dataTable id="tblSs" value="#{billController.billSessions}" var="bs" emptyMessage="No Numbers Yet">
                                                            <f:facet name="header">
                                                                <h:outputLabel value="#{billController.lastBillItem.item.name}" />

                                                                <h:outputLabel id="lblTemS" value="#{billController.sessionDate}" >
                                                                    <f:convertDateTime  timeZone="Asia/Colombo" pattern="dd MMM yyyy" ></f:convertDateTime>
                                                                </h:outputLabel>



                                                            </f:facet>
                                                            <p:column headerText="No.">
                                                                <h:outputLabel value="#{bs.serialNo}" />
                                                            </p:column>
                                                            <p:column headerText="Client">
                                                                <h:outputLabel value="#{bs.billItem.bill.patient.person.nameWithTitle}" />
                                                            </p:column>
                                                        </p:dataTable>
                                                    </p:panel>
                                                </p:panel>
                                            </h:panelGroup>
                                        </div>
                                        <div class="col col-md-6" >
                                            <h:panelGroup id="panelBillItems" >
                                                <p:tabView id="tblBillItem" >
                                                    <p:tab id="tabBillItems" title="Bill Items" >
                                                        <p:dataTable id="tblRequests" rowIndexVar="rowIndex" value="#{billController.lstBillEntries}" var="bi" >

                                                            <p:column>
                                                                <f:facet name="header">No</f:facet>
                                                                    #{rowIndex+1}
                                                            </p:column>
                                                            <p:column>
                                                                <f:facet name="header">Item</f:facet>
                                                                    #{bi.billItem.item.name}
                                                            </p:column>
                                                            <p:column>
                                                                <f:facet name="header">Fee</f:facet>
                                                                <h:outputLabel value="#{bi.billItem.netValue}">
                                                                    <f:convertNumber pattern="#,##0.00" />
                                                                </h:outputLabel>
                                                            </p:column>
                                                            <p:column>
                                                                <f:facet name="header">Department</f:facet>
                                                                    #{bi.billItem.item.department.name}
                                                            </p:column>
                                                            <p:column>
                                                                <f:facet name="header">Priority</f:facet>
                                                                <p:selectOneMenu value="#{bi.billItem.priority}"    >
                                                                    <p:ajax event="blur" process="@this" ></p:ajax>
                                                                    <f:selectItem itemLabel="Not Set" ></f:selectItem>
                                                                    <f:selectItems value="#{enumController.priorities}" ></f:selectItems>
                                                                </p:selectOneMenu>
                                                            </p:column>
                                                            <p:column>
                                                                <h:commandButton id="btnRemove" value="X" action="#{billController.removeBillItem}" >
                                                                    <f:setPropertyActionListener  value="#{rowIndex}" target="#{billController.index}" />
                                                                    <p:ajax  process="btnRemove" update=":#{p:component('tblBillItem')}" />
                                                                </h:commandButton>
                                                            </p:column>
                                                        </p:dataTable>
                                                    </p:tab>
                                                    <p:tab id="tabBillIx" title="Tests" >
                                                        <p:dataTable rowIndexVar="rowIndex" value="#{billController.lstBillComponents}" var="bix" >
                                                            <p:column>
                                                                <f:facet name="header">No</f:facet>
                                                                    #{rowIndex+1}
                                                            </p:column>
                                                            <p:column>
                                                                <f:facet name="header">Name</f:facet>
                                                                    #{bix.item.name}
                                                            </p:column>

                                                        </p:dataTable>
                                                    </p:tab>

                                                    <p:tab id="tabBillFee" title="Fees" >
                                                        <p:dataTable rowIndexVar="rowIndex" value="#{billController.lstBillFees}" var="bif" >
                                                            <p:column>
                                                                <f:facet name="header">Item Name</f:facet>
                                                                <h:outputLabel value="#{bif.billItem.item.name}" />
                                                            </p:column>
                                                            <p:column>
                                                                <f:facet name="header">Fee</f:facet>
                                                                <h:inputText autocomplete="off"  required="true" requiredMessage="Please Check Changed Fees.Please enter correct value or Zero"
                                                                             id="txtFeeVal" 
                                                                             value="#{bif.feeGrossValue}" disabled="#{!bif.billItem.item.userChangable}" >
                                                                    <f:convertNumber pattern="#,##0.00" />
                                                                    <f:ajax event="keyup" execute="@this" 
                                                                            render=":#{p:component('tblRequests')}"
                                                                            listener="#{billController.feeChangeListener(bif)}" />
                                                                </h:inputText>
                                                            </p:column>
                                                            <p:column>
                                                                <p:commandButton ajax="false" value="Update" action="#{billController.feeChangeListener(bif)}" />
                                                            </p:column>
                                                            <p:column>
                                                                <f:facet name="header">Fee Name</f:facet>
                                                                <h:outputLabel value="#{bif.fee.name}" rendered="#{bif.fee !=null}" ></h:outputLabel>
                                                            </p:column>



                                                            <p:column>
                                                                <f:facet name="header">Speciality</f:facet>
                                                                <h:outputLabel value="#{bif.fee.speciality.name}" rendered="#{bif.fee !=null and bif.fee.speciality!=null}" ></h:outputLabel>
                                                            </p:column>

                                                            <p:column>
                                                                <f:facet name="header">Payee</f:facet>                                                
                                                                <p:selectOneMenu value="#{bif.staff}" rendered="#{bif.fee.speciality!=null}" filter="true" filterMatchMode="contains">
                                                                    <f:selectItem itemLabel="Select Staff" />
                                                                    <f:selectItems  value="#{staffController.getSpecialityStaff(bif.fee.speciality)}" var="bifs" itemLabel="#{bifs.person.name}" itemValue="#{bifs}" />
                                                                </p:selectOneMenu>

                                                            </p:column>
                                                        </p:dataTable>
                                                    </p:tab>
                                                </p:tabView>
                                            </h:panelGroup>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-footer" >
                                    footer
                                </div>

                            </div>

                            <p:panel style="min-height: 600px; position:relative;"  >




                                <h:panelGrid columns="2" >



                                    <h:panelGrid columns="1" >







                                    </h:panelGrid>


                                </h:panelGrid>
                            </p:panel>
                        </h:panelGroup>



                        <h:panelGroup rendered="#{sessionController.loggedPreference.opdBillPaperType eq 'FiveFivePrintedPaper'}">
                            <div class="nonPrintBlock">
                                <p:commandButton value="Print" 
                                                 process="@this" 
                                                 update="@all" 
                                                 type="button"  
                                                 ajax="false">
                                    <p:printer target="gpBillPreview" ></p:printer>
                                </p:commandButton>

                                <p:commandButton value="New Bill" ajax="false" action="#{billController.prepareNewBill()}" >
                                </p:commandButton>
                                <p:commandButton ajax="false" value="Batch Cancel" action="#{billController.cancellAll}" style="float: right;"
                                                 onclick="if (!confirm('Are you sure you want to Cancel This Bill ?'))
                                                             return false;"/>
                            </div>
                            <p:outputLabel value="Balance = #{billController.cashBalance}" style="font-weight: bold;font-size: 20pt;color: red;"/>
                            <h:panelGroup id="gpBillPreview">
                                <ui:repeat value="#{billController.bills}" var="bill">
                                    <bi:opdBillPrintRuhunu bill="#{bill}" dup="false"/>
                                </ui:repeat>
                            </h:panelGroup>
                        </h:panelGroup>

                        <h:panelGroup rendered="#{sessionController.loggedPreference.opdBillPaperType eq 'FiveFivePaper'}">
                            <div class="nonPrintBlock">
                                <p:commandButton value="Print" ajax="false" action="#"  >
                                    <p:printer target="fiveFivePaperWithHeadings" ></p:printer>
                                </p:commandButton>

                                <p:commandButton value="New Bill" ajax="false" action="#{billController.prepareNewBill()}" >
                                </p:commandButton>

                                <p:commandButton ajax="false" value="Batch Cancel" action="#{billController.cancellAll}" style="float: right;"
                                                 onclick="if (!confirm('Are you sure you want to Cancel This Bill ?'))
                                                             return false;"/>
                            </div>
                            <h:panelGroup id="fiveFivePaperWithHeadings">
                                <ui:repeat value="#{billController.bills}" var="b">
                                    <bi:five_five_paper_with_headings bill="#{b}"/>                        
                                </ui:repeat>
                            </h:panelGroup>
                        </h:panelGroup>

                        <h:panelGroup rendered="#{sessionController.loggedPreference.opdBillPaperType eq 'PosPaper'}">
                            <h:panelGrid rendered="#{sessionController.loggedPreference.opdPosBillWithoutLogo eq false}">
                                <div class="nonPrintBlock">
                                    <p:commandButton value="Print" ajax="false" action="#"  >
                                        <p:printer target="gpPosBill" ></p:printer>
                                    </p:commandButton>



                                    <p:commandButton value="New Bill" ajax="false" action="#{billController.prepareNewBill()}" >
                                    </p:commandButton>

                                    <p:commandButton ajax="false" value="Batch Cancel" action="#{billController.cancellAll}" style="float: right;"
                                                     onclick="if (!confirm('Are you sure you want to Cancel This Bill ?'))
                                                                 return false;"/>
                                </div>
                                <h:panelGroup id="gpPosBill">
                                    <div style="page-break-after: always;">

                                        <ui:repeat value="#{billController.bills}" var="b">
                                            <bi:posOpdBill bill="#{b}" duplicate="false"/>                        
                                        </ui:repeat>
                                    </div>
                                    <div></div>
                                    <div style="page-break-after: always;">

                                        <ui:repeat value="#{billController.bills}" var="b">
                                            <bi:posOpdBill bill="#{b}" duplicate="false"/>                        
                                        </ui:repeat>
                                    </div>
                                </h:panelGroup>
                            </h:panelGrid>




                            <h:panelGrid rendered="#{sessionController.loggedPreference.opdPosBillWithoutLogo eq true}">
                                <div class="nonPrintBlock">
                                    <p:commandButton value="Print" ajax="false" action="#"  >
                                        <p:printer target="gpPosBillWithoutLogo" ></p:printer>
                                    </p:commandButton>

                                    <p:commandButton value="New Bill" ajax="false" action="#{billController.prepareNewBill()}" >
                                    </p:commandButton>

                                    <p:commandButton ajax="false" value="Batch Cancel" action="#{billController.cancellAll}" style="float: right;"
                                                     onclick="if (!confirm('Are you sure you want to Cancel This Bill ?'))
                                                                 return false;"/>
                                </div>
                                <h:panelGroup id="gpPosBillWithoutLogo">
                                    <div style="page-break-after: always;">

                                        <ui:repeat value="#{billController.bills}" var="b">
                                            <bi:posOpdBillWithoutLogo bill="#{b}" duplicate="false"/>                        
                                        </ui:repeat>
                                    </div>     
                                    <div style="page-break-after: always;">

                                        <ui:repeat value="#{billController.bills}" var="b">
                                            <bi:posOpdBillWithoutLogo bill="#{b}" duplicate="false"/>                        
                                        </ui:repeat>
                                    </div>  
                                </h:panelGroup>
                            </h:panelGrid>

                        </h:panelGroup>



                    </h:form>

                </h:panelGroup>
            </ui:define>

        </ui:composition>

    </h:body>
</html>
